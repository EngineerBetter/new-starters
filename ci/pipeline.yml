---
alerts: &alerts
  on_success:
    put: slack
    params:
      alert_type: fixed
      disable: ((disable_alerts))
  on_failure:
    put: slack
    params:
      alert_type: broke
      disable: ((disable_alerts))
  on_error:
    put: slack
    params:
      alert_type: broke
      color: "#F5A623"
      disable: ((disable_alerts))

resource_types:
- name: slack-alert
  type: registry-image
  source:
    repository: arbourd/concourse-slack-alert-resource

resources:
- name: new-starters
  type: git
  webhook_token: ((webhook_token))
  source:
    uri: https://github.com/EngineerBetter/new-starters.git
    branch: main
- name: concourse-tasks
  type: git
  source:
    uri: https://github.com/EngineerBetter/concourse-tasks.git
    tag_filter: 0.0.39
- name: pcf-ops
  type: registry-image
  icon: docker
  source:
    repository: engineerbetter/pcf-ops
    username: ((dockerhub_user))
    password: ((dockerhub_password))
- name: slack
  type: slack-alert
  source:
    url: ((slack_webhook))
    channel: '#integrations'
    username: admin
    password: ((concourse_password))

jobs:
- name: set-pipeline
  <<: *alerts
  plan:
  - get: new-starters
    trigger: true
  - set_pipeline: self
    file: new-starters/ci/pipeline.yml

- name: create-icebox
  serial: true
  <<: *alerts
  plan:
  - in_parallel:
    - get: new-starters
      trigger: true
      passed: [set-pipeline]
    - get: concourse-tasks
    - get: pcf-ops
  - task: delete-stories
    file: new-starters/ci/delete-stories.yml
    params:
      TRACKER_PROJECT_ID: &tracker_project_id "2530961"
      TRACKER_TOKEN: ((tracker_token))
  - task: generate-csvs
    file: new-starters/ci/generate-tracker-csvs.yml
    image: pcf-ops
  - task: convert-csvs
    file: new-starters/ci/convert-csv-to-json.yml
  - task: create-stories
    file: new-starters/ci/create-stories.yml
    params:
      TRACKER_PROJECT_ID: *tracker_project_id
      TRACKER_TOKEN: ((tracker_token))